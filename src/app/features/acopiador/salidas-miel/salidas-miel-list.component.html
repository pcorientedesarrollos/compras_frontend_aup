<!-- ============================================================================
     📦 LISTADO DE SALIDAS DE MIEL CON TAMBORES
     ============================================================================ -->

<div class="p-6 max-w-7xl mx-auto">
    <!-- ============================================================================
       HEADER
       ============================================================================ -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <h1 class="text-2xl font-bold text-gray-900">Salidas de Miel</h1>
            <button (click)="crearNuevaSalida()"
                class="bg-honey-primary hover:bg-honey-dark text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                <app-icon name="plus" size="sm" />
                Nueva Salida
            </button>
        </div>
        <p class="text-sm text-gray-600">
            Gestión de salidas de miel con sistema de tambores
        </p>
    </div>

    <!-- ============================================================================
       FILTROS
       ============================================================================ -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Estado -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                <select [(ngModel)]="filterEstado" (ngModelChange)="onFilterChange()"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-honey-primary">
                    <option value="">Todos</option>
                    <option [value]="EstadoSalida.EN_PROCESO">En Proceso</option>
                    <option [value]="EstadoSalida.FINALIZADA">Finalizada</option>
                    <option [value]="EstadoSalida.EN_TRANSITO">En Tránsito</option>
                    <option [value]="EstadoSalida.VERIFICADA">Verificada</option>
                </select>
            </div>

            <!-- Fecha Inicio -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                <input type="date" [(ngModel)]="filterFechaInicio" (ngModelChange)="onFilterChange()"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-honey-primary" />
            </div>

            <!-- Fecha Fin -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                <input type="date" [(ngModel)]="filterFechaFin" (ngModelChange)="onFilterChange()"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-honey-primary" />
            </div>

            <!-- Botón limpiar filtros -->
            <div class="flex items-end">
                <button (click)="clearFilters()"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm hover:bg-gray-50 transition-colors">
                    <app-icon name="x-circle" size="sm" class="inline mr-1" />
                    Limpiar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
       TABLA DE SALIDAS
       ============================================================================ -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        @if (loading()) {
        <!-- Loading State -->
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-honey-primary mx-auto mb-4"></div>
            <p class="text-gray-600">Cargando salidas...</p>
        </div>
        } @else if (salidas().length === 0) {
        <!-- Empty State -->
        <div class="text-center py-12 px-6">
            <app-icon name="inbox" size="2xl" class="text-gray-400 mx-auto mb-4" />
            <p class="text-lg font-medium text-gray-900 mb-1">No hay salidas registradas</p>
            <p class="text-sm text-gray-500 mb-4">Comience creando una nueva salida de miel</p>
            <button (click)="crearNuevaSalida()"
                class="bg-honey-primary hover:bg-honey-dark text-white px-4 py-2 rounded-lg inline-flex items-center gap-2">
                <app-icon name="plus" size="sm" />
                Nueva Salida
            </button>
        </div>
        } @else {
        <!-- Tabla -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Folio</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chofer</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tambores</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Kilos</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Estado</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @for (salida of salidas(); track salida.id) {
                    <tr class="hover:bg-gray-50">
                        <!-- Folio -->
                        <td class="px-4 py-3 text-sm font-mono font-semibold text-gray-900">
                            {{ salida.folio }}
                        </td>

                        <!-- Fecha -->
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {{ formatDate(salida.fecha) }}
                        </td>

                        <!-- Chofer -->
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {{ salida.choferNombre }}
                        </td>

                        <!-- Tambores -->
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ salida.cantidadTambores }} tambores
                            </span>
                        </td>

                        <!-- Kilos -->
                        <td class="px-4 py-3 text-sm text-right font-semibold text-gray-900">
                            {{ formatKilos(salida.totalKilos) }}
                        </td>

                        <!-- Total -->
                        <td class="px-4 py-3 text-sm text-right font-semibold text-green-700">
                            {{ formatCurrency(salida.totalCompra) }}
                        </td>

                        <!-- Estado -->
                        <td class="px-4 py-3 text-center">
                            <span [class]="getEstadoBadgeClass(salida.estado)"
                                class="px-2.5 py-0.5 rounded-full text-xs font-medium">
                                {{ getEstadoLabel(salida.estado) }}
                            </span>
                        </td>

                        <!-- Acciones -->
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <!-- Ver Detalle (siempre disponible) -->
                                <button (click)="verDetalle(salida)"
                                    class="text-blue-600 hover:bg-blue-50 p-1.5 rounded transition-colors"
                                    title="Ver detalle">
                                    <app-icon name="eye" size="sm" />
                                </button>

                                <!-- Editar (solo EN_PROCESO) -->
                                @if (puedeEditar(salida)) {
                                <button (click)="editarSalida(salida)"
                                    class="text-honey-primary hover:bg-honey-50 p-1.5 rounded transition-colors"
                                    title="Editar">
                                    <app-icon name="pencil" size="sm" />
                                </button>
                                }

                                <!-- Finalizar (solo EN_PROCESO) -->
                                @if (puedeFinalizar(salida)) {
                                <button (click)="finalizarSalida(salida)"
                                    class="text-green-600 hover:bg-green-50 p-1.5 rounded transition-colors"
                                    title="Finalizar"
                                    [disabled]="processingAction()">
                                    <app-icon name="check-circle" size="sm" />
                                </button>
                                }

                                <!-- Marcar en Tránsito (solo FINALIZADA) -->
                                @if (puedeMarcarEnTransito(salida)) {
                                <button (click)="marcarEnTransito(salida)"
                                    class="text-purple-600 hover:bg-purple-50 p-1.5 rounded transition-colors"
                                    title="Marcar en tránsito"
                                    [disabled]="processingAction()">
                                    <app-icon name="arrow-right" size="sm" />
                                </button>
                                }

                                <!-- Cancelar (solo EN_PROCESO) -->
                                @if (puedeCancelar(salida)) {
                                <button (click)="cancelarSalida(salida)"
                                    class="text-red-600 hover:bg-red-50 p-1.5 rounded transition-colors"
                                    title="Cancelar salida"
                                    [disabled]="processingAction()">
                                    <app-icon name="x-circle" size="sm" />
                                </button>
                                }
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        @if (totalPages() > 1) {
        <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Mostrando <span class="font-medium">{{ (currentPage() - 1) * pageSize() + 1 }}</span> a
                <span class="font-medium">{{ Math.min(currentPage() * pageSize(), totalItems()) }}</span> de
                <span class="font-medium">{{ totalItems() }}</span> resultados
            </div>

            <div class="flex items-center gap-2">
                <button (click)="previousPage()" [disabled]="currentPage() === 1"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <app-icon name="chevron-left" size="sm" />
                </button>

                <span class="text-sm text-gray-700">
                    Página <span class="font-medium">{{ currentPage() }}</span> de <span class="font-medium">{{ totalPages()
                        }}</span>
                </span>

                <button (click)="nextPage()" [disabled]="currentPage() === totalPages()"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <app-icon name="chevron-right" size="sm" />
                </button>
            </div>
        </div>
        }
        }
    </div>

    <!-- LEYENDA DE ESTADOS -->
    <div class="mt-6 bg-gray-50 rounded-lg border border-gray-200 p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Flujo de Estados:</h3>
        <div class="flex items-center gap-4 text-sm text-gray-600">
            <div class="flex items-center gap-2">
                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">En
                    Proceso</span>
                <span>→</span>
            </div>
            <div class="flex items-center gap-2">
                <span
                    class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Finalizada</span>
                <span>→</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">En
                    Tránsito</span>
                <span>→</span>
            </div>
            <div>
                <span
                    class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Verificada</span>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
            * Solo se pueden añadir/quitar tambores en estado "En Proceso"
        </p>
    </div>
</div>
