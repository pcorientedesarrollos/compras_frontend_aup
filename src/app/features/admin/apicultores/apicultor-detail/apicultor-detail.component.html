<div class="apicultor-detail-container">
    <!-- Header -->
    <div class="header-section">
        <div class="header-content">
            <button class="back-button" (click)="cancel()">
                <app-icon name="arrow-left" size="md" />
            </button>

            <div class="flex items-center space-x-3">
                <div class="icon-wrapper">
                    <app-icon name="bee" size="xl" color="text-honey-primary" />
                </div>
                <div>
                    <h1 class="page-title">{{ pageTitle() }}</h1>
                    <p class="page-subtitle">
                        @if (mode() === 'create') {
                        Complete los datos del nuevo apicultor
                        } @else {
                        Edite la información del apicultor
                        }
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading()) {
    <div class="loading-section">
        <div class="loading-spinner"></div>
        <p>Cargando información del apicultor...</p>
    </div>
    }

    <!-- Form -->
    @if (!isLoading()) {
    <form [formGroup]="apicultorForm" (ngSubmit)="onSubmit()" class="form-container">

        <!-- Sección 1: Identificación -->
        <div class="form-section">
            <h2 class="section-title">
                <app-icon name="identification" size="md" color="text-honey-primary" />
                <span>Identificación</span>
            </h2>

            <div class="form-grid">
                <!-- Estatus (ARRIBA) -->
                <div class="form-group">
                    <label for="estatus" class="form-label">
                        Estatus <span class="required">*</span>
                    </label>
                    <select id="estatus" formControlName="estatus" class="form-input">
                        <option value="ACTIVO">Activo</option>
                        <option value="INACTIVO">Inactivo</option>
                    </select>
                </div>

                <!-- Espacio vacío para alineación -->
                <div class="form-group"></div>

                <!-- Nombre -->
                <div class="form-group">
                    <label for="nombre" class="form-label">
                        Nombre(s) <span class="required">*</span>
                    </label>
                    <input id="nombre" type="text" formControlName="nombre" class="form-input"
                        placeholder="Ej: Juan Carlos" maxlength="100"
                        [class.error]="hasError('nombre', 'required') || hasError('nombre', 'maxlength')">
                    @if (hasError('nombre', 'required') || hasError('nombre', 'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('nombre') }}</span>
                    }
                </div>

                <!-- Apellido Paterno -->
                <div class="form-group">
                    <label for="apellidoPaterno" class="form-label">
                        Apellido Paterno <span class="required">*</span>
                    </label>
                    <input id="apellidoPaterno" type="text" formControlName="apellidoPaterno" class="form-input"
                        placeholder="Ej: Pérez" maxlength="100"
                        [class.error]="hasError('apellidoPaterno', 'required') || hasError('apellidoPaterno', 'maxlength')">
                    @if (hasError('apellidoPaterno', 'required') || hasError('apellidoPaterno', 'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('apellidoPaterno') }}</span>
                    }
                </div>

                <!-- Apellido Materno (Opcional) -->
                <div class="form-group">
                    <label for="apellidoMaterno" class="form-label">
                        Apellido Materno (Opcional)
                    </label>
                    <input id="apellidoMaterno" type="text" formControlName="apellidoMaterno" class="form-input"
                        placeholder="Ej: García" maxlength="100"
                        [class.error]="hasError('apellidoMaterno', 'maxlength')">
                    @if (hasError('apellidoMaterno', 'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('apellidoMaterno') }}</span>
                    }
                </div>

                <!-- CURP -->
                <div class="form-group">
                    <label for="curp" class="form-label">
                        CURP <span class="required">*</span>
                    </label>
                    <input id="curp" type="text" formControlName="curp" class="form-input" placeholder="18 caracteres"
                        maxlength="18"
                        [class.error]="hasError('curp', 'required') || hasError('curp', 'minlength') || hasError('curp', 'maxlength')">
                    @if (hasError('curp', 'required') || hasError('curp', 'minlength') || hasError('curp',
                    'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('curp') }}</span>
                    }
                    @if (mode() === 'edit') {
                    <span class="help-text">El CURP no se puede modificar</span>
                    }
                </div>

                <!-- RFC -->
                <div class="form-group">
                    <label for="rfc" class="form-label">
                        RFC (Opcional)
                    </label>
                    <input id="rfc" type="text" formControlName="rfc" class="form-input" placeholder="13 caracteres"
                        maxlength="13" [class.error]="hasError('rfc', 'maxlength')">
                    @if (hasError('rfc', 'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('rfc') }}</span>
                    }
                    <span class="help-text">Campo opcional</span>
                </div>

                <!-- ID-RASMIEL (ABAJO) -->
                <div class="form-group">
                    <label for="idRasmiel" class="form-label">ID-RASMIEL (Opcional)</label>
                    <input id="idRasmiel" type="text" formControlName="idRasmiel" class="form-input"
                        placeholder="" maxlength="50"
                        [class.error]="hasError('idRasmiel', 'maxlength')">
                    @if (hasError('idRasmiel', 'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('idRasmiel') }}</span>
                    }
                </div>

                <!-- UPPSINIIGA (ABAJO) -->
                <div class="form-group">
                    <label for="uppSiniiga" class="form-label">UPPSINIIGA (Opcional)</label>
                    <input id="uppSiniiga" type="text" formControlName="uppSiniiga" class="form-input"
                        placeholder="" maxlength="50"
                        [class.error]="hasError('uppSiniiga', 'maxlength')">
                    @if (hasError('uppSiniiga', 'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('uppSiniiga') }}</span>
                    }
                </div>
            </div>
        </div>

        <!-- Sección 2: Ubicación -->
        <div class="form-section">
            <h2 class="section-title">
                <app-icon name="map-pin" size="md" color="text-honey-primary" />
                <span>Ubicación</span>
            </h2>

            <div class="form-grid">
                <!-- Estado (con select normal o autocomplete si tienes componente) -->
                <div class="form-group">
                    <label for="estadoCodigo" class="form-label">
                        Estado <span class="required">*</span>
                    </label>
                    <select id="estadoCodigo" formControlName="estadoCodigo" class="form-input"
                        [class.error]="hasError('estadoCodigo', 'required')">
                        <option value="">Seleccione un estado</option>
                        @for (estado of estados(); track estado.value) {
                        <option [value]="estado.value">{{ estado.label }}</option>
                        }
                    </select>
                    @if (hasError('estadoCodigo', 'required')) {
                    <span class="error-message">Selecciona un estado</span>
                    }
                </div>

                <!-- Municipio (carga al seleccionar estado) -->
                <div class="form-group">
                    <label for="municipioCodigo" class="form-label">
                        Municipio <span class="required">*</span>
                    </label>
                    <select id="municipioCodigo" formControlName="municipioCodigo" class="form-input"
                        [class.error]="hasError('municipioCodigo', 'required')">
                        <option value="">Seleccione un municipio</option>
                        @for (municipio of municipios(); track municipio.value) {
                        <option [value]="municipio.value">{{ municipio.label }}</option>
                        }
                    </select>
                    @if (hasError('municipioCodigo', 'required')) {
                    <span class="error-message">Selecciona un municipio</span>
                    }
                    @if (municipios().length === 0) {
                    <span class="help-text">Primero seleccione un estado</span>
                    }
                </div>

                <!-- Dirección -->
                <div class="form-group col-span-2">
                    <label for="direccion" class="form-label">Dirección (Opcional)</label>
                    <textarea id="direccion" formControlName="direccion" class="form-input" rows="2"
                        placeholder="Dirección completa del apicultor"></textarea>
                </div>
            </div>
        </div>

        <!-- Sección 3: Proveedores -->
        <div class="form-section">
            <h2 class="section-title">
                <app-icon name="building-office" size="md" color="text-honey-primary" />
                <span>Proveedores Vinculados</span>
            </h2>

            <div class="proveedores-section">
                <div class="proveedores-actions">
                    @if (!isAcopiador()) {
                    <button type="button" class="btn-secondary" (click)="toggleShowAllProveedores()">
                        <app-icon [name]="showAllProveedores() ? 'eye-slash' : 'eye'" size="sm" />
                        <span>{{ showAllProveedores() ? 'Mostrar Seleccionados' : 'Mostrar Todos' }}</span>
                    </button>

                    @if (showAllProveedores()) {
                    <button type="button" class="btn-select-all" (click)="selectAllProveedores()">
                        <app-icon name="check" size="sm" />
                        <span>Seleccionar todos</span>
                    </button>
                    <button type="button" class="btn-clear-all" (click)="clearAllProveedores()">
                        <app-icon name="x-mark" size="sm" />
                        <span>Limpiar selección</span>
                    </button>
                    }
                    }

                    <span class="selected-count">
                        {{ selectedProveedorIds().length }} seleccionado(s)
                    </span>
                </div>

                <!-- Buscador (solo visible cuando se muestran todos) -->
                @if (showAllProveedores()) {
                <div class="search-box">
                    <input type="text" placeholder="Buscar proveedor por nombre..."
                        [value]="proveedorSearchTerm()" (input)="onProveedorSearch($any($event.target).value)"
                        class="form-input">
                </div>
                }

                <div class="proveedores-grid">
                    @for (proveedor of proveedoresToShow(); track proveedor.idProveedor) {
                    <label class="proveedor-item" [class.selected]="isProveedorSelected(proveedor.idProveedor)">
                        <input type="checkbox" [checked]="isProveedorSelected(proveedor.idProveedor)"
                            [disabled]="isAcopiador()"
                            (change)="toggleProveedor(proveedor.idProveedor)" class="proveedor-checkbox">
                        <div class="proveedor-info">
                            <span class="proveedor-name">{{ proveedor.nombre }}</span>
                            <span class="proveedor-type">{{ proveedor.tipo || 'Sin tipo' }}</span>
                        </div>
                    </label>
                    } @empty {
                    <p class="empty-message">
                        @if (showAllProveedores()) {
                        No se encontraron proveedores
                        } @else {
                        No hay proveedores seleccionados. Haz clic en "Mostrar Todos" para seleccionar.
                        }
                    </p>
                    }
                </div>

                <p class="help-text">
                    Selecciona los proveedores con los que este apicultor trabajará.
                    Puedes seleccionar múltiples proveedores.
                </p>
            </div>
        </div>

        <!-- Sección 4: Relación de Colmenas / Apiarios (Solo en modo CREATE) -->
        @if (mode() === 'create') {
        <div class="form-section apiario-section">
            <h2 class="section-title">
                <app-icon name="map-pin" size="md" color="text-honey-primary" />
                <span>Relación de Colmenas</span>
                <span class="badge-required">Mínimo 1</span>
            </h2>

            <div class="apiarios-table-container" [formGroup]="apiariosForm">
                <!-- Header con nombre del apicultor -->
                <div class="apiarios-header">
                    <span class="apicultor-name">
                        {{ apicultorForm.get('nombre')?.value || 'Nombre' }}
                        {{ apicultorForm.get('apellidoPaterno')?.value || 'Apellido' }}
                    </span>
                </div>

                <!-- Fila de inputs para agregar -->
                <div class="apiarios-add-row">
                    <span class="add-row-label">Nombre del apiario</span>
                    <span class="add-row-label">No. de colmenas</span>
                    <span class="add-row-label">Producción (kg)</span>
                    <span class="add-row-label">Latitud</span>
                    <span class="add-row-label">Longitud</span>
                    <button type="button" class="btn-add-apiario" (click)="addApiario()" title="Agregar apiario">
                        <app-icon name="plus" size="sm" />
                    </button>
                </div>

                <!-- Tabla de apiarios -->
                <div class="apiarios-table">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-no">NO.</th>
                                <th class="col-nombre">APIARIO</th>
                                <th class="col-colmenas">COLMENAS</th>
                                <th class="col-prodxcol">PRODxCOL</th>
                                <th class="col-prodanual">PRODxANUAL</th>
                                <th class="col-ubicacion">UBICACIÓN</th>
                                <th class="col-acciones">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody formArrayName="apiarios">
                            @for (apiario of apiariosArray.controls; track $index; let i = $index) {
                            <tr [formGroupName]="i" [class.has-error]="hasApiarioErrors(i)">
                                <!-- Número -->
                                <td class="col-no">{{ i + 1 }}</td>

                                <!-- Nombre -->
                                <td class="col-nombre">
                                    <input type="text" formControlName="nombre"
                                        class="table-input"
                                        placeholder="Nombre del apiario"
                                        [class.error]="hasApiarioError(i, 'nombre', 'required')">
                                </td>

                                <!-- Colmenas -->
                                <td class="col-colmenas">
                                    <input type="number" formControlName="colmenas"
                                        class="table-input"
                                        placeholder="0" min="1" max="10000"
                                        [class.error]="hasApiarioError(i, 'colmenas', 'required')">
                                </td>

                                <!-- Producción por colmena -->
                                <td class="col-prodxcol">
                                    <input type="number" formControlName="produccion"
                                        class="table-input"
                                        placeholder="0" min="0.01" max="1000" step="0.01"
                                        [class.error]="hasApiarioError(i, 'produccion', 'required')">
                                </td>

                                <!-- Producción anual calculada -->
                                <td class="col-prodanual">
                                    <span class="calculated-value">{{ getProduccionAnual(i) | number:'1.0-0' }}</span>
                                </td>

                                <!-- Ubicación (lat, long) -->
                                <td class="col-ubicacion">
                                    <div class="ubicacion-inputs">
                                        <input type="number" formControlName="latitud"
                                            class="table-input-small"
                                            placeholder="Lat" min="-90" max="90" step="0.000001"
                                            [class.error]="hasApiarioError(i, 'latitud', 'required')">
                                        <span class="ubicacion-separator">,</span>
                                        <input type="number" formControlName="longitud"
                                            class="table-input-small"
                                            placeholder="Long" min="-180" max="180" step="0.000001"
                                            [class.error]="hasApiarioError(i, 'longitud', 'required')">
                                        <button type="button" class="btn-gps-small"
                                            (click)="getCurrentLocation(i)"
                                            [disabled]="isGettingLocationFor(i)"
                                            title="Usar mi ubicación">
                                            @if (isGettingLocationFor(i)) {
                                            <div class="spinner-xs"></div>
                                            } @else {
                                            <app-icon name="map-pin" size="xs" />
                                            }
                                        </button>
                                    </div>
                                </td>

                                <!-- Acciones -->
                                <td class="col-acciones">
                                    <button type="button" class="btn-delete-row"
                                        (click)="removeApiario(i)"
                                        [disabled]="apiariosArray.length === 1"
                                        title="Eliminar apiario">
                                        <app-icon name="trash" size="sm" />
                                    </button>
                                </td>
                            </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td colspan="2" class="totals-label">TOTALES</td>
                                <td class="totals-value">{{ totalColmenas() | number:'1.0-0' }}</td>
                                <td></td>
                                <td class="totals-value">{{ totalProduccionAnual() | number:'1.0-0' }} KGS</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        }

        <!-- Botones de acción -->
        <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="cancel()" [disabled]="isSaving()">
                <app-icon name="x-mark" size="sm" />
                <span>Cancelar</span>
            </button>

            <button type="submit" class="btn-submit" [disabled]="!isFormValid() || isSaving()">
                @if (isSaving()) {
                <div class="spinner-small"></div>
                <span>Guardando...</span>
                } @else {
                <app-icon name="check" size="sm" />
                <span>{{ submitButtonText() }}</span>
                }
            </button>
        </div>
    </form>
    }
</div>

<!-- Modal de Confirmación para Cancelar -->
<app-modal [isOpen]="showCancelModal()" (closed)="closeCancelModal()" size="sm">
    <div modal-header>
        <div class="flex items-center space-x-2 text-amber-600">
            <app-icon name="exclamation-triangle" size="md" />
            <span class="font-semibold">Confirmar cancelación</span>
        </div>
    </div>
    <div modal-body>
        <p class="text-gray-600">
            ¿Deseas cancelar? Los cambios no guardados se perderán.
        </p>
    </div>
    <div modal-footer class="flex justify-end space-x-3">
        <button type="button" class="btn-cancel" (click)="closeCancelModal()">
            <span>No, continuar editando</span>
        </button>
        <button type="button" class="btn-confirm-cancel" (click)="confirmCancel()">
            <app-icon name="x-mark" size="sm" />
            <span>Sí, cancelar</span>
        </button>
    </div>
</app-modal>

<!-- Modal de Progreso para Guardado de Apiarios -->
@if (showProgressModal()) {
<div class="progress-modal-overlay">
    <div class="progress-modal">
        <div class="progress-modal-content">
            <div class="progress-icon">
                <app-icon name="bee" size="xl" color="text-honey-primary" />
            </div>
            <h3 class="progress-title">Guardando apiarios...</h3>
            <p class="progress-message">{{ progressMessage() }}</p>

            <div class="progress-counter">
                {{ apiariosSaved() }}/{{ apiariosTotal() }}
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" [style.width.%]="progressPercent()"></div>
            </div>

            <div class="progress-percent">{{ progressPercent() }}%</div>
        </div>
    </div>
</div>
}
