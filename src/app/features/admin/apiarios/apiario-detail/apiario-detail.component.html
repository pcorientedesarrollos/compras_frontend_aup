<!-- ============================================================================
     üè† APIARIO DETAIL - TEMPLATE
     ============================================================================ -->

<div class="form-container">
    <!-- Header -->
    <div class="form-header">
        <div class="header-content">
            <!-- ‚úÖ NUEVO: Bot√≥n de regresar -->
            <button type="button" class="back-button" (click)="goBack()">
                <app-icon name="arrow-left" size="md" />
            </button>

            <div class="flex items-center space-x-3">
                <div class="icon-wrapper">
                    <app-icon name="home" size="xl" color="text-honey-primary" />
                </div>
                <div>
                    <h1 class="page-title">{{ pageTitle() }}</h1>
                    <p class="page-subtitle">
                        {{ mode() === 'create' ? 'Registra un nuevo apiario' : 'Modifica los datos del apiario' }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>
    } @else {

    <!-- Formulario -->
    <form [formGroup]="apiarioForm" (ngSubmit)="onSubmit()" class="form-content">

        <!-- Secci√≥n 1: Informaci√≥n del Apiario -->
        <div class="form-section">
            <h2 class="section-title">
                <app-icon name="document-text" size="md" color="text-honey-primary" />
                <span>Informaci√≥n del Apiario</span>
            </h2>

            <div class="form-grid">
                <!-- Apicultor con Autocomplete -->
                <div class="form-group col-span-2">
                    <app-autocomplete-select formControlName="apicultorId" [options]="apicultoresActivos()"
                        optionValue="id" optionLabel="nombre" [optionTemplate]="formatApicultorLabel"
                        placeholder="Buscar apicultor por c√≥digo o nombre..." label="Apicultor" [required]="true"
                        [disabled]="mode() === 'edit'"
                        [errorMessage]="hasError('apicultorId', 'required') ? getErrorMessage('apicultorId') : ''" />
                    @if (mode() === 'edit') {
                    <p class="help-text mt-2">El apicultor no se puede cambiar en modo edici√≥n</p>
                    }
                </div>

                <!-- Nombre del Apiario -->
                <div class="form-group col-span-2">
                    <label for="nombre" class="form-label">
                        Nombre del Apiario <span class="required">*</span>
                    </label>
                    <input id="nombre" type="text" formControlName="nombre" class="form-input"
                        placeholder="Ej: Apiario Principal"
                        [class.error]="hasError('nombre', 'required') || hasError('nombre', 'minlength') || hasError('nombre', 'maxlength')">
                    @if (hasError('nombre', 'required') || hasError('nombre', 'minlength') || hasError('nombre',
                    'maxlength')) {
                    <span class="error-message">{{ getErrorMessage('nombre') }}</span>
                    }
                </div>

                <!-- N√∫mero de Colmenas -->
                <div class="form-group">
                    <label for="colmenas" class="form-label">
                        N√∫mero de Colmenas <span class="required">*</span>
                    </label>
                    <input id="colmenas" type="number" formControlName="colmenas" class="form-input" min="1" max="9999"
                        placeholder="Ej: 50"
                        [class.error]="hasError('colmenas', 'required') || hasError('colmenas', 'min') || hasError('colmenas', 'max')">
                    @if (hasError('colmenas', 'required') || hasError('colmenas', 'min') || hasError('colmenas',
                    'max')) {
                    <span class="error-message">{{ getErrorMessage('colmenas') }}</span>
                    }
                    <p class="help-text">Valor entre 1 y 9999</p>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 2: Ubicaci√≥n GPS -->
        <div class="form-section">
            <h2 class="section-title">
                <app-icon name="map-pin" size="md" color="text-honey-primary" />
                <span>Ubicaci√≥n GPS</span>
            </h2>

            <div class="geolocation-button-wrapper">
                <button type="button" class="btn-geolocation" (click)="getCurrentLocation()"
                    [disabled]="isGettingLocation()">
                    @if (isGettingLocation()) {
                    <div class="spinner-small"></div>
                    <span>Obteniendo ubicaci√≥n...</span>
                    } @else {
                    <app-icon name="map" size="sm" />
                    <span>Usar mi ubicaci√≥n actual</span>
                    }
                </button>

                @if (geolocationError()) {
                <div class="geolocation-error">
                    <app-icon name="exclamation-circle" size="sm" />
                    <span>{{ geolocationError() }}</span>
                </div>
                }
            </div>

            <div class="form-grid">
                <!-- Latitud -->
                <div class="form-group">
                    <label for="latitud" class="form-label">
                        Latitud <span class="required">*</span>
                    </label>
                    <input id="latitud" type="number" formControlName="latitud" class="form-input" step="0.000001"
                        placeholder="Ej: 17.0654"
                        [class.error]="hasError('latitud', 'required') || hasError('latitud', 'min') || hasError('latitud', 'max')">
                    @if (hasError('latitud', 'required') || hasError('latitud', 'min') || hasError('latitud', 'max'))
                    {
                    <span class="error-message">{{ getErrorMessage('latitud') }}</span>
                    }
                    <p class="help-text">Valor entre -90 y 90</p>
                </div>

                <!-- Longitud -->
                <div class="form-group">
                    <label for="longitud" class="form-label">
                        Longitud <span class="required">*</span>
                    </label>
                    <input id="longitud" type="number" formControlName="longitud" class="form-input" step="0.000001"
                        placeholder="Ej: -96.7236"
                        [class.error]="hasError('longitud', 'required') || hasError('longitud', 'min') || hasError('longitud', 'max')">
                    @if (hasError('longitud', 'required') || hasError('longitud', 'min') || hasError('longitud',
                    'max')) {
                    <span class="error-message">{{ getErrorMessage('longitud') }}</span>
                    }
                    <p class="help-text">Valor entre -180 y 180</p>
                </div>
            </div>

            <!-- Preview de mapa (opcional) -->
            @if (apiarioForm.get('latitud')?.valid && apiarioForm.get('longitud')?.valid) {
            <div class="map-preview">
                <p class="map-preview-text">
                    <app-icon name="map" size="sm" />
                    <span>
                        Ubicaci√≥n: {{ apiarioForm.get('latitud')?.value | number:'1.6-6' }},
                        {{ apiarioForm.get('longitud')?.value | number:'1.6-6' }}
                    </span>
                </p>
                <a href="https://www.google.com/maps?q={{ apiarioForm.get('latitud')?.value }},{{ apiarioForm.get('longitud')?.value }}"
                    target="_blank" class="map-preview-link">
                    Ver en Google Maps
                    <app-icon name="arrow-up-tray" size="sm" />
                </a>
            </div>
            }
        </div>

        <!-- Botones de acci√≥n -->
        <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="cancel()" [disabled]="isSaving()">
                <app-icon name="x-mark" size="sm" />
                <span>Cancelar</span>
            </button>

            <button type="submit" class="btn-submit" [disabled]="!isFormValid() || isSaving()">
                @if (isSaving()) {
                <div class="spinner-small"></div>
                <span>Guardando...</span>
                } @else {
                <app-icon name="check" size="sm" />
                <span>{{ submitButtonText() }}</span>
                }
            </button>
        </div>
    </form>
    }
</div>