<!-- Modal Overlay -->
@if (isOpen()) {
<div class="modal-overlay" (click)="onClose()" (keydown)="onKeydown($event)">
    <!-- Modal Container -->
    <div class="modal-container" (click)="onModalClick($event)">

        <!-- Header -->
        <div class="modal-header">
            <div class="header-content">
                <div class="flex items-center space-x-3">
                    <div class="icon-wrapper">
                        <app-icon name="building-office" size="xl" color="text-honey-primary" />
                    </div>
                    <div>
                        <h2 class="modal-title">{{ proveedor().nombre }}</h2>
                        <p class="modal-subtitle">
                            ID: {{ proveedor().idProveedor }}
                            @if (proveedor().tipo) {
                            <span class="separator">•</span>
                            <span>{{ proveedor().tipo }}</span>
                            }
                        </p>
                    </div>
                </div>

                <button class="close-button" (click)="onClose()" title="Cerrar (Esc)">
                    <app-icon name="x-mark" size="md" />
                </button>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs-nav">
                @for (tab of tabs(); track tab.id) {
                <button class="tab-button" [class.active]="isTabActive(tab.id)" (click)="selectTab(tab.id)">
                    <app-icon [name]="tab.icon" size="sm" />
                    <span>{{ tab.label }}</span>
                </button>
                }
            </div>
        </div>

        <!-- Body -->
        <div class="modal-body">

            <!-- TAB 1: INFORMACIÓN GENERAL -->
            @if (activeTab() === 'general') {
            <div class="tab-content">
                <div class="info-grid">

                    <!-- Columna 1 -->
                    <div class="info-section">
                        <h3 class="section-title">Datos Generales</h3>

                        <div class="info-item">
                            <label>Nombre / Razón Social:</label>
                            <span class="font-semibold">{{ proveedor().nombre }}</span>
                        </div>

                        <div class="info-item">
                            <label>Tipo de Proveedor:</label>
                            @if (proveedor().tipo) {
                            <app-badge [variant]="proveedor().tipo === 'ACOPIADOR' ? 'info' : 'success'" size="sm">
                                {{ proveedor().tipo }}
                            </app-badge>
                            } @else {
                            <span class="text-gray-500">No especificado</span>
                            }
                        </div>

                        <div class="info-item">
                            <label>Estado:</label>
                            <app-badge [variant]="obtenerVarianteBadgeEstado(proveedor().activoInactivo)" size="sm">
                                {{ obtenerTextoEstado(proveedor().activoInactivo) }}
                            </app-badge>
                        </div>

                        <div class="info-item">
                            <label>Registro SAGARPA:</label>
                            <span>{{ proveedor().idSagarpa || 'Sin registro' }}</span>
                        </div>
                    </div>

                    <!-- Columna 2 -->
                    <div class="info-section">
                        <h3 class="section-title">Producción</h3>

                        <div class="info-item">
                            <label>Tipo de Miel:</label>
                            <span class="font-semibold">{{ proveedor().tipoDeMielNombre || 'No especificado' }}</span>
                        </div>

                        <div class="info-item">
                            <label>Cantidad (kg):</label>
                            <span class="font-mono text-honey-dark font-bold">
                                {{ proveedor().cantidad !== null ? proveedor().cantidad!.toLocaleString('es-MX', {
                                minimumFractionDigits: 2 }) : '0.00' }} kg
                            </span>
                        </div>

                        <div class="info-item">
                            <label>Apicultores Asociados:</label>
                            <span class="font-bold text-blue-600">{{ proveedor().cantidadApicultores }}</span>
                        </div>

                        <div class="info-item">
                            <label>ID Empresa:</label>
                            <span>{{ proveedor().empresa || 'No especificado' }}</span>
                        </div>
                    </div>

                    <!-- Columna 3 -->
                    <div class="info-section">
                        <h3 class="section-title">Referencias</h3>

                        <div class="info-item">
                            <label>ID Comprador:</label>
                            <span>{{ proveedor().idComprador || 'N/A' }}</span>
                        </div>

                        <div class="info-item">
                            <label>ID Datos Fiscales:</label>
                            <span>{{ proveedor().idDatosFiscales || 'N/A' }}</span>
                        </div>

                        <div class="info-item">
                            <label>ID Dirección:</label>
                            <span>{{ proveedor().idDireccion || 'N/A' }}</span>
                        </div>

                        <div class="info-item">
                            <label>ID Estado:</label>
                            <span>{{ proveedor().idEstado || 'N/A' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- TAB 2: APICULTORES -->
            @if (activeTab() === 'apicultores') {
            <div class="tab-content">
                <div class="apicultores-header">
                    <p class="text-sm text-gray-600">
                        Total de apicultores asociados:
                        <span class="font-bold text-gray-900">{{ proveedor().cantidadApicultores }}</span>
                    </p>
                </div>

                <app-honey-table [columns]="apicultoresColumns()" [data]="apicultores()"
                    [config]="apicultoresTableConfig()" rowKey="id">
                </app-honey-table>

                <!-- Paginación (si hay más de 10) -->
                @if (apicultorestotalPages() > 1) {
                <div class="pagination-container">
                    <button class="pagination-button" [disabled]="apicultoresPage() === 1"
                        (click)="onApicultoresPageChange(apicultoresPage() - 1)">
                        <app-icon name="chevron-left" size="sm" />
                        Anterior
                    </button>

                    <span class="pagination-info">
                        Página {{ apicultoresPage() }} de {{ apicultorestotalPages() }}
                    </span>

                    <button class="pagination-button" [disabled]="apicultoresPage() === apicultorestotalPages()"
                        (click)="onApicultoresPageChange(apicultoresPage() + 1)">
                        Siguiente
                        <app-icon name="chevron-right" size="sm" />
                    </button>
                </div>
                }
            </div>
            }

            <!-- TAB 3: INVENTARIO DE MIEL -->
            @if (activeTab() === 'inventario') {
            <div class="tab-content">
                <div class="inventario-header">
                    <p class="text-sm text-gray-600 mb-4">
                        Inventario disponible de miel por tipo
                    </p>
                </div>

                @if (proveedor().inventarioMiel && proveedor().inventarioMiel!.length > 0) {
                <div class="inventario-grid">
                    @for (item of proveedor().inventarioMiel; track item.tipoMielId) {
                    <div class="inventario-card">
                        <div class="card-header">
                            <div class="flex items-center space-x-2">
                                <app-icon name="shopping-bag" size="lg" color="text-honey-primary" />
                                <h4 class="card-title">{{ item.tipoMielNombre }}</h4>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="inventario-item">
                                <span class="item-label">Total Entradas:</span>
                                <span class="item-value text-green-600">
                                    +{{ item.totalEntradas.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }} kg
                                </span>
                            </div>
                            <div class="inventario-item">
                                <span class="item-label">Total Salidas:</span>
                                <span class="item-value text-red-600">
                                    -{{ item.totalSalidas.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }} kg
                                </span>
                            </div>
                            <div class="inventario-item-destacado">
                                <span class="item-label-destacado">Disponible:</span>
                                <span class="item-value-destacado">
                                    {{ item.disponible.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }} kg
                                </span>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                } @else {
                <div class="empty-state">
                    <app-icon name="shopping-bag" size="xl" color="text-gray-400" />
                    <p class="text-gray-500">No hay inventario disponible</p>
                </div>
                }
            </div>
            }

            <!-- TAB 4: MAPA GPS -->
            @if (activeTab() === 'mapa') {
            <div class="tab-content">
                <div class="map-section">
                    <div class="map-info">
                        <div class="coordinate-item">
                            <app-icon name="map-pin" size="md" color="text-honey-primary" />
                            <div>
                                <label>Latitud:</label>
                                <span class="font-mono font-bold">{{ proveedor().latitud }}</span>
                            </div>
                        </div>
                        <div class="coordinate-item">
                            <app-icon name="map-pin" size="md" color="text-honey-primary" />
                            <div>
                                <label>Longitud:</label>
                                <span class="font-mono font-bold">{{ proveedor().longitud }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mapa Leaflet -->
                    <app-leaflet-map
                        [latitude]="proveedor().latitud!"
                        [longitude]="proveedor().longitud!"
                        [markerTitle]="proveedor().nombre"
                        [zoom]="13"
                        [height]="'450px'">
                    </app-leaflet-map>
                </div>
            </div>
            }
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button class="footer-button secondary" (click)="onClose()">
                <app-icon name="x-mark" size="sm" />
                Cerrar
            </button>
        </div>
    </div>
</div>
}